{% extends 'admin/layout/user.twig' %}
{% block style_below %}
    <link rel="stylesheet" href="/public/css/medium-editor.min.css"/>
    <link rel="stylesheet" href="/public/css/medium-theme.min.css"/>
{% endblock %}
{% block content %}
    <main class="main">
        <div class="container-fluid mt-4">
            <div class="card card-default">
                <div class="card-body">
                    <h3>پیام های شما</h3>
                    <div class="orders-heading">
                        <div class="table-filter">
                            <label for="read-messages" class="label-cbx">
                                <input id="read-messages" type="checkbox" class="invisible" {{ read ? "checked" : "" }}/>
                                <div class="checkbox">
                                    <svg width="20px" height="20px" viewbox="0 0 20 20">
                                        <path d="M3,1 L17,1 L17,1 C18.1045695,1 19,1.8954305 19,3 L19,17 L19,17 C19,18.1045695 18.1045695,19 17,19 L3,19 L3,19 C1.8954305,19 1,18.1045695 1,17 L1,3 L1,3 C1,1.8954305 1.8954305,1 3,1 Z"></path>
                                        <polyline points="4 11 8 15 16 6"></polyline>
                                    </svg>
                                </div>
                                <span>خوانده شده</span>
                            </label>
                            <label for="unread-messages" class="label-cbx">
                                <input id="unread-messages" type="checkbox" class="invisible" {{ unread ? "checked" : "" }}/>
                                <div class="checkbox">
                                    <svg width="20px" height="20px" viewbox="0 0 20 20">
                                        <path d="M3,1 L17,1 L17,1 C18.1045695,1 19,1.8954305 19,3 L19,17 L19,17 C19,18.1045695 18.1045695,19 17,19 L3,19 L3,19 C1.8954305,19 1,18.1045695 1,17 L1,3 L1,3 C1,1.8954305 1.8954305,1 3,1 Z"></path>
                                        <polyline points="4 11 8 15 16 6"></polyline>
                                    </svg>
                                </div>
                                <span>خوانده نشده
                                </span>
                            </label>
                            <label for="answered-messages" class="label-cbx">
                                <input id="answered-messages" type="checkbox" class="invisible" {{ answered ? "checked" : "" }}/>
                                <div class="checkbox">
                                    <svg width="20px" height="20px" viewbox="0 0 20 20">
                                        <path d="M3,1 L17,1 L17,1 C18.1045695,1 19,1.8954305 19,3 L19,17 L19,17 C19,18.1045695 18.1045695,19 17,19 L3,19 L3,19 C1.8954305,19 1,18.1045695 1,17 L1,3 L1,3 C1,1.8954305 1.8954305,1 3,1 Z"></path>
                                        <polyline points="4 11 8 15 16 6"></polyline>
                                    </svg>
                                </div>
                                <span>پاسخ داده شده
                                </span>
                            </label>
                            <label for="unanswered-messages" class="label-cbx">
                                <input id="unanswered-messages" type="checkbox" class="invisible" {{ unanswered ? "checked" : "" }}/>
                                <div class="checkbox">
                                    <svg width="20px" height="20px" viewbox="0 0 20 20">
                                        <path d="M3,1 L17,1 L17,1 C18.1045695,1 19,1.8954305 19,3 L19,17 L19,17 C19,18.1045695 18.1045695,19 17,19 L3,19 L3,19 C1.8954305,19 1,18.1045695 1,17 L1,3 L1,3 C1,1.8954305 1.8954305,1 3,1 Z"></path>
                                        <polyline points="4 11 8 15 16 6"></polyline>
                                    </svg>
                                </div>
                                <span>پاسخ داده نشده
                                </span>
                            </label>
                        </div>
                        <button data-toggle="modal" data-target="#newMessageModal" class="btn new-ticket-btn">
                            <i class="icon-plus"></i>
                            ارسال پیام جدید
                        </button>
                    </div>

                    <table id="messages-table" class="table">
                        <thead>
                            <tr>
                                <th class="bg-teal-dark">#</th>
                                <th class="bg-teal-dark">عنوان پیام</th>
                                <th class="bg-teal-dark">وضعیت خوانده شدن</th>
                                <th class="bg-teal-dark">وضعیت پاسخ داده شدن</th>
                                <th class="bg-teal-dark">زمان ارسال</th>
                                <th class="bg-teal-dark">آخرین بروزرسانی</th>
                                <th class="bg-teal-dark">جزییات</th>
                            </tr>
                        </thead>
                        <tbody id="user-messages">
                            {% for message in messages %}
                                <tr>
                                    <td>{{ message.msg_id }}</td>
                                    <td>{{ message.subject }}</td>
                                    <td>
                                        {{ message.is_read == "0" ? "خوانده نشده" : "خوانده شده" }}
                                    </td>
                                    <td>
                                        {{
                  message.is_answered == "0"
                    ? "پاسخ داده نشده"
                    : "پاسخ داده شده"
                }}
                                    </td>
                                    <td>{{ message.create_date_persian }}</td>
                                    <td>{{ message.update_date_persian }}</td>
                                    <td class="order-more-info">
                                        <a href="/user/message/view/{{ message.msg_id }}">
                                            <svg width="13px" height="23px" viewbox="0 0 50 80" xml:space="preserve">
                                                <polyline fill="none" stroke="#a9a9a9" stroke-width="10" stroke-linecap="round" stroke-linejoin="round" points="45.63,75.8 0.375,38.087 45.63,0.375 "/></svg >
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% if messages_count > 10 %}
                        {% set last_page = messages_count / 10 %}
                        <nav class="page-navigation" aria-label="Page navigation example">
                            <ul class="pagination">
                                {% if current_page != 1 %}
                                    <li class="page-item">
                                        <a class="page-link" href="/user/messages" aria-label="Previous">
                                            <span aria-hidden="true">&laquo;</span>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="/user/messages?page={{ current_page - 1 }}" aria-label="Previous">
                                            قبلی
                                        </a>
                                    </li>
                                {% endif %}
                                {% if current_page + 2 > last_page %}
                                    {% set end_index = last_page %}
                                    {% set start_index
            =current_page-(3-(last_page-current_page)) %}
                                {% else %}
                                    {% set
            start_index = current_page - 2 %}
                                    {% if start_index <= 0 %}
                                        {% set
                                        start_index = 1 %}
                                    {% endif %}
                                    {% set end_index = current_page + 2
 %}
                                {% endif %}
                                {% for page_number in range(start_index, end_index)
 %}
                                    {% if page_number == current_page %}
                                        {% set pagination_class =
            "page-item active" %}
                                    {% else %}
                                        {% set pagination_class =
            "page-item" %}
                                    {% endif %}

                                    <li class="{{ pagination_class }}">
                                        <a class="page-link" href="/user/messages?page={{ page_number }}">{{ page_number }}</a >
                                    </li>
                                {% endfor %}
                                {% if current_page != last_page %}

                                    <li class="page-item">
                                        <a class="page-link" href="/user/messages?page={{ current_page + 1 }}" aria-label="Previous">
                                            بعدی
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="/user/messages?page={{ last_page }}" aria-label="Next">
                                            <span aria-hidden="true">&raquo;</span>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </main>
    <!-- Modal -->
    <div class="modal fade" id="newMessageModal" tabindex="-1" role="dialog" aria-labelledby="newMessageModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newMessageModalLabel">ارسال پیام</h5>
                </div>
                <div class="modal-body">
                    <form action="/user/message/send" id="sendMessageForm" method="POST">
                        <div class="row">
                            <div class="form-group col-md-3">
                                <label for="">نام شما</label>
                                <input class="form-control" type="text" value="{{user.fname ~ " " ~ user.lname}}" disabled="disabled"/>
                            </div>
                            <div class="form-group col-md-5">
                                <label for="">ایمیل شما</label>
                                <input class="form-control" type="email" value="{{ user.email }}" disabled="disabled"/>
                            </div>
                            <div class="form-group col-md-4">
                                <label for="">عنوان پیام</label>
                                <input class="form-control" type="text" id="subject" name="subject"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="">پیام شما</label>
                            <textarea name="body" id="medium-editor" cols="30" rows="10"></textarea>
                        </div>
                        <button type="button" class="btn btn-primary" id="send-message-btn">
                            ارسال
                        </button>
                        <button type="button" class="btn btn-danger" data-dismiss="modal">
                            انصراف
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block script_below %}

    <script src="/public/js/panel/user-orders.js"></script>
    <script src="/public/js/panel/medium-editor.min.js"></script>
    <script src="/public/js/sweetalert2@8.js"></script>
    <script src="/public/js/panel/user-messages.js"></script>
    
    <script>
        let editor = new MediumEditor("#medium-editor", {elementsContainer: document.getElementById("newMessageModal")});

    </script>
{% endblock %}